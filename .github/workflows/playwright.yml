name: Playwright Tests - CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run tests daily at 10 AM UTC
    - cron: '0 10 * * *'

jobs:
  # Job 1: Test on QA Environment
  test-qa:
    name: Test QA Environment
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}

    - name: Run tests on QA with ${{ matrix.browser }}
      run: |
        export ENV=qa
        export BROWSER=${{ matrix.browser }}
        npm run test
      env:
        CI: true

    - name: Convert Cucumber to Allure
      if: always()
      run: npm run allure:convert

    - name: Generate Allure Report
      if: always()
      run: npm run allure:generate

    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report-qa-${{ matrix.browser }}
        path: allure-report/
        retention-days: 30

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results-qa-${{ matrix.browser }}
        path: allure-results/
        retention-days: 30

  # # Job 2: Test on INT1 Environment
  # test-int1:
  #   name: Test INT1 Environment
  #   timeout-minutes: 60
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       browser: [chromium, firefox]
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4

  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: lts/*
  #       cache: 'npm'

  #   - name: Install dependencies
  #     run: npm ci

  #   - name: Install Playwright Browsers
  #     run: npx playwright install --with-deps ${{ matrix.browser }}

  #   - name: Run tests on INT1 with ${{ matrix.browser }}
  #     run: |
  #       export ENV=int1
  #       export BROWSER=${{ matrix.browser }}
  #       npm run test
  #     env:
  #       CI: true
  #     continue-on-error: true

  #   - name: Convert Cucumber to Allure
  #     if: always()
  #     run: npm run allure:convert

  #   - name: Generate Allure Report
  #     if: always()
  #     run: npm run allure:generate

  #   - name: Upload Allure Report
  #     if: always()
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: allure-report-int1-${{ matrix.browser }}
  #       path: allure-report/
  #       retention-days: 30

  # Job 3: Code Quality Check
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check Node.js version
      run: node --version

    - name: Check npm version
      run: npm --version

    - name: List installed packages
      run: npm list --depth=0

  # Job 4: Generate Test Report Summary
  test-report-summary:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [test-qa]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all Allure reports
      uses: actions/download-artifact@v4
      with:
        path: reports

    - name: Create Summary Report
      run: |
        echo "# Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Environment: QA" >> $GITHUB_STEP_SUMMARY
        echo "- Chromium: ‚úì" >> $GITHUB_STEP_SUMMARY
        echo "- Firefox: ‚úì" >> $GITHUB_STEP_SUMMARY
        echo "- WebKit (Safari): ‚úì" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- All tests executed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Reports available in artifacts" >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚úÖ Test automation pipeline completed!\n\nüìä Artifacts:\n- Allure Reports (QA: Chrome, Firefox, Safari)\n- Test Results\n\nüîç Check the artifacts section for detailed reports.'
          })

  # Job 5: Notifications (Optional)
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [test-qa]
    if: always()
    steps:
    - name: Workflow Status
      run: |
        echo "‚úÖ CI/CD Pipeline Completed"
        echo "Job Status: ${{ job.status }}"
        echo "Workflow Status: ${{ needs.test-qa.result }}"
